#!/usr/bin/env bash
set -euo pipefail

# ==========================================================
# gpioflow installer (Debian Bookworm / Raspberry Pi)
# - installs: Java 17, MariaDB, pigpiod, Tomcat9 (tarball)
# - downloads: SQL + WAR from gpioflow.com
# - deploys: WAR to Tomcat
# - enables autostart: pigpiod, mariadb, tomcat9
# ==========================================================

# -------------------------
# App / Download URLs
# -------------------------
APP_NAME="gpioflow"

SQL_URL="https://gpioflow.com/software/latest/sql/gpioflow.sql"

# TODO: HIER deine echte WAR-URL eintragen:
WAR_URL="https://gpioflow.com/software/latest/war/gpioflow.war"

# -------------------------
# DB user (für deine App)
# -------------------------
DB_NAME="gpioflow"
DB_USER="gpioflow_databaseuser"
DB_PASS="${DB_PASS:-gpp117898227}"   # empfohlen: beim Install setzen: DB_PASS='...' ./install.sh

# -------------------------
# Tomcat Tarball
# -------------------------
TOMCAT_USER="tomcat"
TOMCAT_GROUP="tomcat"
TOMCAT_DIR="/opt/tomcat"
TOMCAT_VER="9.0.113"

# -------------------------
# Paths
# -------------------------
TMP_DIR="/tmp/gpioflow-install"
WAR_LOCAL="${TMP_DIR}/${APP_NAME}.war"
SQL_LOCAL="${TMP_DIR}/${APP_NAME}.sql"
TOMCAT_WEBAPPS="${TOMCAT_DIR}/webapps"

# -------------------------
# Helpers
# -------------------------
log() { echo -e "[gpioflow] $*"; }

require_root() {
  if [[ "${EUID}" -ne 0 ]]; then
    echo "Bitte als root ausführen (oder: sudo ./install.sh)"
    exit 1
  fi
}

detect_java_home() {
  local java_bin
  java_bin="$(readlink -f /usr/bin/java || true)"
  [[ -n "${java_bin}" && -x "${java_bin}" ]] || { echo ""; return; }
  echo "$(dirname "$(dirname "${java_bin}")")"
}

mysql_cmd() {
  # Standard Debian/RPi: root via unix_socket => kein Passwort nötig.
  # Falls jemand root-Passwort hat: vor Aufruf setzen:
  #   export MYSQL_PWD='deinpass'
  # oder: MYSQL_PWD='deinpass' sudo -E ./install.sh
  mysql
}

# ==========================================================
# Start
# ==========================================================
require_root

log "prepare temp dir"
rm -rf "${TMP_DIR}"
mkdir -p "${TMP_DIR}"

log "apt update & install packages"
apt update
apt install -y \
  openjdk-17-jre-headless \
  mariadb-server \
  curl ca-certificates tar \
  pigpiod \
  libpigpiod-if2-1

JAVA_HOME="$(detect_java_home)"
if [[ -z "${JAVA_HOME}" ]]; then
  echo "Konnte JAVA_HOME nicht ermitteln. Prüfe Java Installation."
  exit 1
fi
log "JAVA_HOME=${JAVA_HOME}"

# ==========================================================
# Services: pigpiod + mariadb (autostart)
# ==========================================================
log "enable & start pigpiod"
systemctl enable --now pigpiod

log "enable & start mariadb"
systemctl enable --now mariadb

# ==========================================================
# Download SQL + Import
# ==========================================================
log "download SQL from ${SQL_URL}"
curl -fL "${SQL_URL}" -o "${SQL_LOCAL}"

log "import SQL (creates DB + tables via CREATE DATABASE + USE in file)"
mysql_cmd < "${SQL_LOCAL}"

# ==========================================================
# Create / ensure app DB user (after schema import)
# ==========================================================
log "ensure database user '${DB_USER}' exists and has privileges"
mysql_cmd <<EOF
CREATE USER IF NOT EXISTS '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASS}';
GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'localhost';
FLUSH PRIVILEGES;
EOF

# ==========================================================
# Tomcat install (tarball)
# ==========================================================
log "ensure tomcat user exists"
if ! id -u "${TOMCAT_USER}" >/dev/null 2>&1; then
  useradd -r -m -U -d "${TOMCAT_DIR}" -s /usr/sbin/nologin "${TOMCAT_USER}"
fi

log "download & install Tomcat ${TOMCAT_VER} to ${TOMCAT_DIR}"
cd /tmp
TARBALL="apache-tomcat-${TOMCAT_VER}.tar.gz"
URL="https://dlcdn.apache.org/tomcat/tomcat-9/v${TOMCAT_VER}/bin/${TARBALL}"

# Stop service if it exists (upgrade-safe)
if systemctl list-unit-files | grep -q '^tomcat9\.service'; then
  log "stopping existing tomcat9 (if running)"
  systemctl stop tomcat9 || true
fi

curl -fL "${URL}" -o "${TARBALL}"

mkdir -p "${TOMCAT_DIR}"
rm -rf "${TOMCAT_DIR:?}/"*     # clean install dir (keeps directory itself)
tar -xzf "${TARBALL}" -C "${TOMCAT_DIR}" --strip-components=1

log "set permissions on Tomcat"
chown -R "${TOMCAT_USER}:${TOMCAT_GROUP}" "${TOMCAT_DIR}"
chmod -R u+rwX,go+rX "${TOMCAT_DIR}"
chmod +x "${TOMCAT_DIR}/bin/"*.sh

log "write systemd service /etc/systemd/system/tomcat9.service"
cat > /etc/systemd/system/tomcat9.service <<EOF
[Unit]
Description=Apache Tomcat 9 (gpioflow)
After=network.target mariadb.service pigpiod.service
Wants=mariadb.service pigpiod.service

[Service]
Type=forking
User=${TOMCAT_USER}
Group=${TOMCAT_GROUP}

Environment="JAVA_HOME=${JAVA_HOME}"
Environment="CATALINA_HOME=${TOMCAT_DIR}"
Environment="CATALINA_BASE=${TOMCAT_DIR}"
Environment="CATALINA_PID=${TOMCAT_DIR}/temp/tomcat.pid"
Environment="CATALINA_OPTS=-Xms256M -Xmx512M -server -Djava.awt.headless=true"
Environment="JAVA_OPTS=-Djava.security.egd=file:/dev/./urandom"

ExecStart=${TOMCAT_DIR}/bin/startup.sh
ExecStop=${TOMCAT_DIR}/bin/shutdown.sh

SuccessExitStatus=143
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

log "reload systemd"
systemctl daemon-reload

# ==========================================================
# Download WAR + Deploy
# ==========================================================
log "download WAR from ${WAR_URL}"
curl -fL "${WAR_URL}" -o "${WAR_LOCAL}"

log "deploy WAR to Tomcat webapps"
systemctl stop tomcat9 || true
sleep 2

rm -f  "${TOMCAT_WEBAPPS}/${APP_NAME}.war"
rm -rf "${TOMCAT_WEBAPPS:?}/${APP_NAME}"

cp "${WAR_LOCAL}" "${TOMCAT_WEBAPPS}/${APP_NAME}.war"
chown "${TOMCAT_USER}:${TOMCAT_GROUP}" "${TOMCAT_WEBAPPS}/${APP_NAME}.war"

# ==========================================================
# Enable autostart (final) + start tomcat
# ==========================================================
log "enable autostart: pigpiod, mariadb, tomcat9"
systemctl enable pigpiod mariadb tomcat9

log "start tomcat9"
systemctl start tomcat9

# ==========================================================
# Done
# ==========================================================
IP="$(hostname -I 2>/dev/null | awk '{print $1}' || true)"
log "done"
echo "Open: http://${IP:-$(hostname)}:8080/${APP_NAME}"
echo "Tomcat logs:  journalctl -u tomcat9 -f"
echo "pigpiod:      systemctl status pigpiod --no-pager"
echo "mariadb:      systemctl status mariadb --no-pager"
